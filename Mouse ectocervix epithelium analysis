library(Seurat)
library(dplyr)

# Road cellranger count processed data
mouse_epithelial = Read10X('../mouse/outs/filtered_feature_bc_matrix')
mouse_epithelial = CreateSeuratObject(counts = mouse_epithelial, project = "mouse_epithelial", min.features = 200, min.cells = 3)

# Scrublet in python (remove doublet cells)
import sys
import os
import scrublet as scr
import scipy.io
import numpy as np
import pandas as pd
from os.path import expanduser

home = expanduser("~")
input_dir = '../mouse/outs/filtered_feature_bc_matrix'
out_dir = '../mouse'

counts_matrix = scipy.io.mmread(input_dir + '/matrix.mtx').T.tocsc()
genes = np.array(scr.load_genes(input_dir + '/features.tsv', delimiter = '\t', column = 1))
barcodes = np.loadtxt(input_dir + '/barcodes.tsv', dtype = 'str')

scrub = scr.Scrublet(counts_matrix, expected_doublet_rate = 0.06)
doublet_scores, predicted_doublets = scrub.scrub_doublets(min_counts = 2, min_cells = 3, min_gene_variability_pctl = 85, n_prin_comps = 30)

scrub_obs = pd.DataFrame({ "barcodes" : barcodes, "doublet_scores_obs" : scrub.doublet_scores_obs_, "threshold" : scrub.threshold_})
scrub_sim = pd.DataFrame({ "doublet_scores_sim" : scrub.doublet_scores_sim_, "threshold" : scrub.threshold_})

scrub_obs.to_csv(out_dir + "/scrublet.doublet_scores_obs.txt", index = False, header = None, sep = "\t")
scrub_sim.to_csv(out_dir + "/scrublet.doublet_scores_sim.txt", index = False, header = None, sep = "\t")

# Scrublet in R (remove doublet cells)
cellranger.dir = '../mouse/outs/filtered_feature_bc_matrix'
scrublet.script <- '../run_scrublet.py'
outdir <- "../mouse"

system(paste("../anaconda3/bin/python", scrublet.script, cellranger.dir, outdir, sep = " "))

db.score <- read.table(file = paste0(outdir, "/scrublet.doublet_scores_obs.txt"), header = F, sep = "\t")
colnames(db.score) <- c("barcodes", "scores", "threshold")

# Embed scrublet results in seurat object
doublet.file <- "../mouse/scrublet.doublet_scores_obs.txt"
doublet.df <- read.table(doublet.file , header = F, sep = "\t")
colnames(doublet.df) <- c("barcodes", "scores", "threshold")
doublet.df$Doublet <- "singlet"
doublet.df$Doublet[doublet.df$scores > doublet.df$threshold] <- "doublet"
doublet.df$barcodes <- do.call(rbind, strsplit(x = as.character(doublet.df$barcodes), split = "\\-"))
metadata = data.frame(barcodes = rownames(mouse_epithelial@meta.data), mouse_epithelial@meta.data)
metadata$barcodes = do.call(rbind, strsplit(rownames(metadata), split = '\\-'))
test <- join(metadata, doublet.df, by = "barcodes")
mouse_epithelial@meta.data$Doublet <- test$Doublet
